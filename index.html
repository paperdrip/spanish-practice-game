<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Spanish Practice Game</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<style>
		body {
			font-family: 'Inter', sans-serif;
			-webkit-tap-highlight-color: transparent;
		}
		.card {
			background-color: white;
			border-radius: 1.5rem;
			padding: 2rem;
			box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
			transition: all 0.3s ease-in-out;
		}
		.btn {
			display: block;
			width: 100%;
			text-align: center;
			padding: 0.75rem 1rem;
			border-radius: 0.75rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease-in-out;
			border: 2px solid transparent;
		}
		.btn-primary {
			background-color: #4f46e5;
			color: white;
		}
		.btn-primary:hover {
			background-color: #4338ca;
		}
		.btn-option {
			background-color: #f3f4f6;
			color: #1f2937;
			border-color: #e5e7eb;
		}
		.btn-option:hover {
			border-color: #4f46e5;
			background-color: #e0e7ff;
		}
		.btn-correct {
			background-color: #22c55e !important;
			border-color: #16a34a !important;
			color: white !important;
		}
		.btn-incorrect {
			background-color: #ef4444 !important;
			border-color: #dc2626 !important;
			color: white !important;
		}
		.btn-disabled {
			opacity: 0.7;
			cursor: not-allowed;
		}
	</style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

	<div id="app-container" class="w-full max-w-2xl mx-auto">
		<!-- Welcome Screen -->
		<div id="welcome-screen" class="card text-center">
			<h1 class="text-4xl font-bold text-slate-900 mb-2">Spanish Practice Game</h1>
			<p class="text-slate-600 mb-8 text-lg">Test your knowledge of common verbs, reflexive verbs, and telling time.</p>
			<p class="text-slate-500 mb-8">You'll answer 20 questions.</p>
			<button id="start-button" class="btn btn-primary w-full sm:w-auto sm:px-16 py-3 text-lg">Start Quiz</button>
		</div>

		<!-- Game Screen -->
		<div id="game-screen" class="hidden">
			<div class="card">
				<div id="progress-container" class="text-center text-sm font-medium text-slate-500 mb-4"></div>
				<div id="question-container" class="text-center text-2xl font-bold text-slate-900 mb-8 min-h-[72px]"></div>
				<div id="answers-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
				<div id="explanation-container" class="hidden bg-slate-50 p-4 rounded-xl text-center text-slate-700 mb-6"></div>
				<button id="next-button" class="btn btn-primary hidden w-full">Next</button>
			</div>
		</div>

		<!-- Summary Screen -->
		<div id="summary-screen" class="hidden card text-center">
			<h2 class="text-3xl font-bold text-slate-900 mb-2">Quiz Complete!</h2>
			<p id="score-container" class="text-xl text-slate-600 mb-8"></p>
			<div id="summary-details" class="text-left space-y-4 mb-8"></div>
			<button id="play-again-button" class="btn btn-primary w-full sm:w-auto sm:px-16 py-3 text-lg">Play Again</button>
		</div>
	</div>

	<script>
		const welcomeScreen = document.getElementById('welcome-screen');
		const gameScreen = document.getElementById('game-screen');
		const summaryScreen = document.getElementById('summary-screen');
		const startButton = document.getElementById('start-button');
		const nextButton = document.getElementById('next-button');
		const playAgainButton = document.getElementById('play-again-button');
		const progressContainer = document.getElementById('progress-container');
		const questionContainer = document.getElementById('question-container');
		const answersContainer = document.getElementById('answers-container');
		const explanationContainer = document.getElementById('explanation-container');
		const scoreContainer = document.getElementById('score-container');
		const summaryDetails = document.getElementById('summary-details');

		// --- GAME CONFIG ---
		const TOTAL_QUESTIONS = 20;
		const VERB_QUESTIONS_COUNT = 10;
		const TIME_QUESTIONS_COUNT = 5;
		const REFLEXIVE_VERB_QUESTIONS_COUNT = 5;
		const CSV_URL = 'acciones-habituales.csv';
		
		// --- REFLEXIVE VERB DATA ---
		const REFLEXIVE_PRONOUNS = ['me', 'te', 'se', 'nos', 'os'];
		const REFLEXIVE_VERBS = [
			'despertarse', 'levantarse', 'acostarse', 'ducharse', 'lavarse', 
			'vestirse', 'maquillarse', 'peinarse', 'sentarse', 'llamarse', 
			'afeitarse', 'quedarse', 'irse'
		];
		const REFLEXIVE_SUBJECTS = [
			{ pronoun: 'Yo', reflexive: 'me' }, { pronoun: 'Tú', reflexive: 'te' },
			{ pronoun: 'Él', reflexive: 'se' }, { pronoun: 'Ella', reflexive: 'se' },
			{ pronoun: 'Usted', reflexive: 'se' }, { pronoun: 'Nosotros', reflexive: 'nos' },
			{ pronoun: 'Vosotros', reflexive: 'os' }, { pronoun: 'Ellos', reflexive: 'se' },
			{ pronoun: 'Ellas', reflexive: 'se' }, { pronoun: 'Ustedes', reflexive: 'se' },
		];

		let verbList = [];
		let questions = [];
		let currentQuestionIndex = 0;
		let score = 0;
		let userAnswers = [];

		// --- HELPER FUNCTIONS ---
		function shuffleArray(array) {
			for (let i = array.length - 1; i > 0; i--) {
				const j = Math.floor(Math.random() * (i + 1));
				[array[i], array[j]] = [array[j], array[i]];
			}
			return array;
		}

		function getRandomElement(array, exclude = null) {
			let element;
			do {
				element = array[Math.floor(Math.random() * array.length)];
			} while (exclude && (element.spanish === exclude.spanish));
			return element;
		}

		// --- DATA LOADING ---
		function parseCSV(csvText) {
			const lines = csvText.trim().split('\n').slice(1); // Skip header
			return lines.map(line => {
				// Regex to match CSV fields (handles quotes with commas inside)
				const regex = /(?:,|^)(?:"([^"]*)"|([^",]*))/g;
				const fields = [];
				let match;
				while ((match = regex.exec(line)) !== null) {
					fields.push(match[1] !== undefined ? match[1] : match[2]);
				}
				
				return { 
					spanish: fields[0]?.trim() || '', 
					english: fields[1]?.trim() || '' 
				};
			}).filter(v => v.spanish && v.english);
		}

		async function loadVerbs() {
			try {
				const response = await fetch(CSV_URL);
				const csvText = await response.text();
				verbList = parseCSV(csvText);
			} catch (error) {
				console.error("Failed to load verb list:", error);
				// Fallback verbs
				verbList = [
					{ spanish: 'trabajar', english: 'to work' },
					{ spanish: 'estudiar', english: 'to study' },
					{ spanish: 'comer', english: 'to eat' },
					{ spanish: 'vivir', english: 'to live' },
					{ spanish: 'hablar', english: 'to speak' },
					{ spanish: 'aprender', english: 'to learn' },
					{ spanish: 'escribir', english: 'to write' },
					{ spanish: 'leer', english: 'to read' },
					{ spanish: 'beber', english: 'to drink' },
					{ spanish: 'correr', english: 'to run' }
				];
			}
		}

		// --- QUESTION GENERATION ---
		function generateVerbQuestions(count) {
			const questions = [];
			const usedIndices = new Set();
			while (questions.length < count && usedIndices.size < verbList.length) {
				const randomIndex = Math.floor(Math.random() * verbList.length);
				if (usedIndices.has(randomIndex)) continue;
				
				usedIndices.add(randomIndex);
				const correctVerb = verbList[randomIndex];
				const distractors = [];
				while (distractors.length < 3) {
					const randomDistractor = getRandomElement(verbList, correctVerb);
					if (!distractors.some(d => d.spanish === randomDistractor.spanish)) {
						 distractors.push(randomDistractor);
					}
				}

				const fromSpanish = Math.random() > 0.5;
				const options = shuffleArray([correctVerb, ...distractors]);
				
				questions.push({
					question: fromSpanish ? `What does "<strong>${correctVerb.spanish}</strong>" mean?` : `How do you say "<strong>${correctVerb.english}</strong>"?`,
					options: options.map(v => fromSpanish ? v.english : v.spanish),
					answer: fromSpanish ? correctVerb.english : correctVerb.spanish,
					explanation: `<strong>${correctVerb.spanish}</strong> means <strong>${correctVerb.english}</strong>.`
				});
			}
			return questions;
		}

		function generateTimeQuestions(count) {
			const questions = [];
			const hoursEs = ["", "una", "dos", "tres", "cuatro", "cinco", "seis", "siete", "ocho", "nueve", "diez", "once", "doce"];
			
			for (let i = 0; i < count; i++) {
				const hour = Math.floor(Math.random() * 12) + 1;
				const minute = Math.floor(Math.random() * 12) * 5;
				
				let timeEs = "";
				if (minute === 0) {
					timeEs = `${hour === 1 ? 'Es la' : 'Son las'} ${hoursEs[hour]}`;
				} else if (minute <= 30) {
					const yPart = minute === 15 ? 'y cuarto' : (minute === 30 ? 'y media' : `y ${minute}`);
					timeEs = `${hour === 1 ? 'Es la' : 'Son las'} ${hoursEs[hour]} ${yPart}`;
				} else { // minute > 30, the "menos" case
					const nextHour = (hour % 12) + 1;
					const article = nextHour === 1 ? 'Es la' : 'Son las';
					const menosPart = minute === 45 ? 'menos cuarto' : `menos ${60 - minute}`;
					timeEs = `${article} ${hoursEs[nextHour]} ${menosPart}`;
				}

				const timeEn = `${hour}:${minute.toString().padStart(2, '0')}`;
				
				const distractors = [];
				while(distractors.length < 3) {
					const dHour = Math.floor(Math.random() * 12) + 1;
					const dMinute = Math.floor(Math.random() * 12) * 5;
					const dTime = `${dHour}:${dMinute.toString().padStart(2, '0')}`;
					if (dTime !== timeEn && !distractors.includes(dTime)) {
						distractors.push(dTime);
					}
				}
				
				questions.push({
					question: `What time is "<strong>${timeEs}</strong>"?`,
					options: shuffleArray([timeEn, ...distractors]),
					answer: timeEn,
					explanation: `<strong>${timeEs}</strong> is <strong>${timeEn}</strong>.`
				});
			}
			return questions;
		}

		function generateReflexiveVerbQuestions(count) {
			const questions = [];
			const usedCombinations = new Set();
			while (questions.length < count) {
				const verb = REFLEXIVE_VERBS[Math.floor(Math.random() * REFLEXIVE_VERBS.length)];
				const subject = REFLEXIVE_SUBJECTS[Math.floor(Math.random() * REFLEXIVE_SUBJECTS.length)];
				const combinationKey = `${subject.pronoun}-${verb}`;

				if (usedCombinations.has(combinationKey)) continue;
				usedCombinations.add(combinationKey);
				
				const isPronounQuestion = Math.random() > 0.5;
				if (isPronounQuestion) {
					questions.push({
						question: `${subject.pronoun} _____ (${verb}) temprano.`,
						options: shuffleArray([...REFLEXIVE_PRONOUNS]),
						answer: subject.reflexive,
						explanation: `For '<strong>${subject.pronoun}</strong>', the pronoun is '<strong>${subject.reflexive}</strong>'.`
					});
				} else {
					const distractors = shuffleArray(REFLEXIVE_VERBS.filter(v => v !== verb)).slice(0, 3);
					questions.push({
						question: `${subject.pronoun} ${subject.reflexive} _____ temprano.`,
						options: shuffleArray([verb, ...distractors]),
						answer: verb,
						explanation: `'<strong>${subject.pronoun} ${subject.reflexive}</strong>' matches '<strong>${verb}</strong>'.`
					});
				}
			}
			return questions;
		}

		// --- GAME FLOW ---
		async function startGame() {
			currentQuestionIndex = 0;
			score = 0;
			userAnswers = [];
			
			if (verbList.length === 0) {
				await loadVerbs();
			}

			const verbQuestions = generateVerbQuestions(VERB_QUESTIONS_COUNT);
			const timeQuestions = generateTimeQuestions(TIME_QUESTIONS_COUNT);
			const reflexiveQuestions = generateReflexiveVerbQuestions(REFLEXIVE_VERB_QUESTIONS_COUNT);
			questions = shuffleArray([...verbQuestions, ...timeQuestions, ...reflexiveQuestions]);

			welcomeScreen.classList.add('hidden');
			summaryScreen.classList.add('hidden');
			gameScreen.classList.remove('hidden');

			displayQuestion();
		}

		function displayQuestion() {
			explanationContainer.classList.add('hidden');
			nextButton.classList.add('hidden');
			answersContainer.innerHTML = '';

			const question = questions[currentQuestionIndex];
			progressContainer.textContent = `Question ${currentQuestionIndex + 1} of ${TOTAL_QUESTIONS}`;
			questionContainer.innerHTML = question.question.replace('_____', '<span class="text-indigo-600 font-mono">____</span>');

			question.options.forEach(option => {
				const button = document.createElement('button');
				button.textContent = option;
				button.classList.add('btn', 'btn-option');
				button.addEventListener('click', selectAnswer);
				answersContainer.appendChild(button);
			});
		}

		function selectAnswer(e) {
			const selectedButton = e.target;
			const selectedAnswer = selectedButton.textContent;
			const currentQuestion = questions[currentQuestionIndex];
			const isCorrect = selectedAnswer === currentQuestion.answer;
			
			if (isCorrect) score++;
			
			userAnswers.push({
				question: currentQuestion.question,
				selected: selectedAnswer,
				correct: currentQuestion.answer,
				isCorrect: isCorrect,
			});

			Array.from(answersContainer.children).forEach(button => {
				button.removeEventListener('click', selectAnswer);
				button.classList.add('btn-disabled');
				if (button.textContent === currentQuestion.answer) {
					button.classList.add('btn-correct');
				} else if (button.textContent === selectedAnswer) {
					button.classList.add('btn-incorrect');
				}
			});
			
			explanationContainer.innerHTML = currentQuestion.explanation;
			explanationContainer.classList.remove('hidden');
			nextButton.classList.remove('hidden');
		}

		function nextQuestion() {
			currentQuestionIndex++;
			if (currentQuestionIndex < TOTAL_QUESTIONS) {
				displayQuestion();
			} else {
				showSummary();
			}
		}

		function showSummary() {
			gameScreen.classList.add('hidden');
			summaryScreen.classList.remove('hidden');
			scoreContainer.textContent = `You scored ${score} out of ${TOTAL_QUESTIONS}!`;
			summaryDetails.innerHTML = '';

			userAnswers.forEach(answer => {
				const resultEl = document.createElement('div');
				resultEl.className = 'p-4 rounded-lg';
				resultEl.style.backgroundColor = answer.isCorrect ? '#f0fdf4' : '#fef2f2';
				resultEl.style.borderColor = answer.isCorrect ? '#bbf7d0' : '#fecaca';
				resultEl.style.borderWidth = '1px';
				
				let questionText = answer.question;
				if(questionText.includes('_____')){
					 questionText = answer.question.replace('_____', `<strong class="font-bold ${answer.isCorrect ? 'text-green-700' : 'text-red-700'}">${answer.selected}</strong>`);
				}
			   
				resultEl.innerHTML = `
					<p class="font-semibold text-slate-800">${questionText}</p>
					<p class="mt-2 ${answer.isCorrect ? 'text-green-700' : 'text-red-700'}">
					   ${answer.isCorrect ? '✓' : '✗'} Your answer: ${answer.selected}
					</p>
					${!answer.isCorrect ? `<p class="mt-1 text-slate-600">Correct answer: <strong>${answer.correct}</strong></p>` : ''}
				`;
				summaryDetails.appendChild(resultEl);
			});
		}

		// --- EVENT LISTENERS ---
		startButton.addEventListener('click', startGame);
		nextButton.addEventListener('click', nextQuestion);
		playAgainButton.addEventListener('click', startGame);
	</script>
</body>
</html>

